package com.samourai.wallet.payload;

import com.samourai.wallet.api.pairing.PairingDojo;
import com.samourai.wallet.api.pairing.PairingType;
import com.samourai.wallet.test.AbstractTest;
import org.json.JSONObject;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;

public class PayloadUtilGenericTest extends AbstractTest {
    private static final Logger log = LoggerFactory.getLogger(PayloadUtilGenericTest.class);

    private String BACKUP_FILE = "{\"version\":2,\"payload\":\"U2FsdGVkX1+vzNxPLqaOpV8Dv7OPnorGrFtAFcqJ+DLQofA2E5IwRU9ZaGw9TExs\\ndHI9PENEOhYq3YKWNH+Sly5ObFSNo8goCHmzpSjYP7za2psfhCI11+1brl4iDqAI\\nKjTSLqwZVSbDcKFAh5lOiSViUwnI+6Q\\/sUrRXYektaFq086Oj0hpr46yUoSy8PsI\\n38bdO0fkjhn5Pa+rE3INldporrdI4vXOJgmUyUJrh0faJNWWAn6AkQdHL0kEX\\/du\\nLat7YI\\/vzKWhlwx8z1i+DwelSyqQq7AyYuJfAmWmyKMyc6G0tNHczASXgzBk3isD\\nubAYguMR8fqBYsqGeWH+6ffRFiCrdCmos\\/uGyKN7KrgwyGGGXY2Bpp8AaEOnwSIY\\na0Ka+GicjPrkONGeHngDawgghLDb5pH9o\\/J052JmbDcHpt\\/Q+3PfzKnVOPTBZdT7\\nBj1jZGLs8fCDXKH+0f3NM3GWZbKZRA\\/fLi91U+pSopXkrcH7CAO2HiXzM1Q5rZFs\\nfgZBZ5GlzTy3ngSI3DHOwxanPeMTdyKFVRfTMlf0bVCC\\/glWXvoJG6emB71WTXh7\\nkTcEhb\\/+GT6YnL0Jq\\/LNjXh7\\/jhZsokYoA7lrVt6VaklA0BmAutRi5a67Ntcp2w6\\nGntx+uiaL5y9lyaTIiwjDLgaaK3Sp7gNYH78UyhvqxdDcSxTS2q4dxNfWjBXaV65\\n2zWtQuVDGL9CHFDO6b9jDvD5RpvPeHa9oQ1xc9csu0h2ozUT95plyR1nnSF5qH+U\\njQJMRe65K4\\/QtW2heBLcLHxy\\/s01unVEb29Jeo\\/Wjl8vbTIcxilALl2ulXwwZtAR\\nPLrFp3fObQ8NGo\\/\\/iuf0LcqxxfuKAr8oOZX4X6zfAivRrcwhLuY6WSng4+QBytOl\\nWtkajwf8cMsRND3xvX9KT6Q2kgAHIQZB8zowVJapHG56IOZHMw7xcLzmJdcGR8Vc\\nIksGkDaBKG7QYW3dUr\\/2DuMHMpsVugtttNweQyqULuviKYAjOtvQMP2mthzQ7eJ1\\nzizvEaHB+UaYIB2KTm9hy7kX9I+c6UmB+8ZxvKncaO3YzEvDqLq8TNqOpv1pK1BM\\nokXVY5TZwYD97D8HZiBdeVxV28T3tWIUfN+EeIwC095F0ith6Hn35nAgUftbE196\\nREpR3FInIMQzaAbXFsiXUpmWFmRU1EmnJGOQ9DxHxCai38dr1RZxii3fifS7TWs8\\nadbB7Gi9Bc3r79yNI2pxyUqj5HjSb0Vk7GOJH2VToivrjM+YSpdyYDnFZw\\/9Bzkj\\nbpLhHR8Y0ZSS9OQijQDuD4Veave+igdx6sf\\/BvdHkf3U0gaSCOCynhS9uLopz5wA\\nhylPGkvJRvsNa3+1OQQVLw9kFCjjh+2+sVeKOBOWNJ1ANKCgQ1AZtfb3aVEQSYAs\\nBAX+q1vI5O\\/rJ6zaWACJbUuwsk3HCg03y83Fv8bXTFM+4GW5XVBB7adpYUWFBERd\\nMBEPFrXwERUsQ\\/51eRr6csOwE9FfB9J+oJ4XyicmN5+KxiVO66CpgnqeNBP4asc1\\nOHdDTrKDHkzutAeMNBGlqmpCLdgtU37eh2NuKfFOleq9zgLPcoAlveD\\/x5uOm\\/5U\\nrfiXSlazSgz7kTVzvUZZQ\\/isrqVar2NN2RDiB+JO3xPeOMSzaKim+FlyUaUWuA2U\\nSxWYRtXQ4xmFsNOF1A3i8MlMI7apG96sLuFtbMe\\/eBxZk1ykW3svJnCjf8rIXpT5\\noUy\\/MnTxRApQBTeYnKTgxNu74Cqw\\/+kRwcStWlNtZwRgK1J8MXVQB+hkj6qzFY+7\\nqO53yLErZN0IzKxEvPSauA5oMkxsIB7aPbyoxzcOQERDMZ35ekwl\\/vx5fk3csk1k\\nxRavH26hz3iFiabKwH1OV+UyeT2ImdJMM9MSSkG8H5qzBxwTE9qUMblrnXphbIt1\\nW2gtwm1e\\/\\/gWKRqzQmSnjDPLaMWwN0G9KOzRTtmccC6pZHp0f2e2XJOJrNO9yCsw\\nK6SvV0JhMjDpnVyx500TtNUkaUiljNU2+Hfo8kOQeDZwnXDhymQQFKSpl5NONzZy\\nE0XT9Y4V3gWxArT4FnSEWC+\\/FBn6XJBimIc6q9\\/9exyMV2ENQ+8PUR+ouSZUfRNI\\njV08mBpSVovTFnR7UD1+bC3lAiLFXIEaxZIDgg6CpAmnDJkZQmTOKk9d1iNi89zN\\n1s5dM5LpahKF6cpmClUc9sx00rTUetG5083o8JWFn75EMdfmu6yIU\\/3Ijduu2Jne\\nXsw18KXv\\/YmPjiZ8gdDwOK21ypvr2zSeFAxOGGcJrFxEmRalWRz2xV3J6MJ5izLL\\nKihKbjJFD7BmX6RLyM9jviRY9CU5\\/uNck3tX80z1tMQ\\/MnYL3q7WzGjpOQBWujzb\\noUZW8AhGjWp4h547FND2jMJX5NZlpGs9cVgKzQBybnd0O2OJOJveZ6et9oi8niNe\\ncJT2V9cj7b9B2Z2fIbMaLILnBynnsJaYbCXO2IIV7CniQ6qyktX6Vb5Pgmc1MN1Z\\nKIp11aeXU87CG\\/I6y0FDVUKvfSxOUsMmW4Uo7RRx+xD5BuZiJBhEqpXIhiGu9+Dx\\nWc0EQgoA6jzMWIPSDZLbHoO6zP2x9LOfUXMaEQgp21bIXi0qYFjtSUsmjXKkFvZS\\nPQuYxrA61FSnSgjUZ591hk67yNAk\\/uzb3e0HFLAQhpev1tWJZiNUMMKOesWshHas\\nrxAYvtp3wNQPsZwAcWQM2K72EFtYLfOqpTLhkhkuhzEG5Oh5vGG\\/Jn+Y4r3oc7YT\\n9Xpt\\/Q9YOFXYZC0B82WJi56NznjjSxwqgbiB1SQw\\/+c87p\\/Qgv7ah+pz2J+jsUZ3\\nL7QlgPdofbQZk3ZXplHcSkAFdgwS1UWhiYOAAqvHIFUWeuOSg37cP4XLxSShC254\\nTRk7Mw\\/JNuSCgZ6aZryni48oGfbCbohPvr28dmG6f1xTbIgGV+MfHiUKLjg\\/eGn+\\nIgOGxIyylftAj2vagcNleXJ9JevdRofMF4dYCPTdnqZCTtGSO0dN1PVf5E6kBXZ6\\noeIxgVQfM8qeaPpXbut6g7edFP7kJtIEIBxtz5HQrsov4Qpzl3hCH1J5\\/WxJYQZw\\npfFv3BCF2PtTyeFhhPXM3jouAh46mHC6grku6dQ26HKgGn0EYhMNEkqQQ1vncIZD\\nP7GhkH\\/hHXB6VltiJVXpFjtxQMx\\/RJKWUqD6WMFoZ6pfe\\/cwjkSxTx5VZ4Jqfz\\/b\\nDbsUtzld65rMA1u8Is2w8Z30A93aYFbToD8CYeCkcQ\\/TIADdfw3BPpnwXi6we34C\\nJcC65brjf6k4vOVFtfLyVr3GHsjq\\/1HpMtEXRiaCNgKpaF59HwI2Z9bR\\/O6bic8C\\neKS2e6h70N0puGJvRdhb1feiWeT33oMZrcUfTpJ4s91L15zHtUd+vsv8500qSeyJ\\nJaJdJFDnRrY7+OhfkIC6GRpnot85Usi\\/CDznGEM21fklx36tQsElv9qeBbQ9MGGZ\\nNRZqjQDsmbq7AYnXrjHnR6L5eyAiRGYGKZnd+a2247QJ\\/t+SCpqQrh+eoDo6tthP\\n8LTIi+srBNjF+swcg3q75CDyN8\\/Ni1TWVlbdUbMfgRgdKzWEwatEYFbjW\\/U0CH2+\\nSnnkUQmz8ibshNra4RUZSjBeWzWPBwQBAFwCtGZRltG4MiWQnFekWHehZ9tpcj1s\\nHjCpr1yaY5PZxubQMlzUlQT60GLtMUOv7fE\\/cmDC9O7MWoFlBI2HkFhpTzEnEust\\nSg+L\\/91gL5RqKx2UwV5gNB1nBlDg4X++XSvblD64+Y3Jh4oEAFaIfzfR1xXgqb7B\\nC+VceZNmY6WH0L3apMC1t4L1ekPMnDUhzq8I0ir6npmwojtIc3+7bPgbzSevqQzs\\nXKIQp58vCMkL+kEuu\\/bvFT1fq+Do8OzHgzUbucs7WrZ1I8f+Oy+04IkA5Fi5iCqL\\n\",\"external\":false}";

    @Test
    public void isBackupFile() throws Exception {
        Assertions.assertTrue(payloadUtil.isBackupFile(BACKUP_FILE));
        Assertions.assertFalse(payloadUtil.isBackupFile("foo"));
        Assertions.assertFalse(payloadUtil.isBackupFile("{foo:bar}"));
        Assertions.assertFalse(payloadUtil.isBackupFile("{version:1}"));
    }

    @Test
    public void getPayload_noDojo_noScode() throws Exception {
        String EXPECTED = "{\"wallet\":{\"swaps_accounts\":[{\"changeIdx\":0,\"id\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\"}],\"whirlpool_account\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TW21vo2zdDK9PZgKqnonnomB2b18dadRTgtnB5F8SZg1reqvMHEDKq1k3oHz1AXbsD6MCfNcw77BqfZxWmZm4nn16XNC84mL\",\"id\":2147483645},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TawqjQNFt5o4sBM1RP1B1mtVZr8ysEA9hFLsZZ4RB8oxE4Sfkumc47jnVPUgRL9hJf3sWpTYBKtdkP3UK6J8p1n2ykmjHnrW\",\"id\":2147483646},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TUJkJddzPVbcMBwTwwvqWNTWNxnHQotZzQocFiXvnVVuiYVb9ZYR58PMnSCUxvHTzpVSCm3ttSLXfVviBJspozHYtu6oNtNY\",\"id\":2147483644}],\"bip84_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\",\"id\":0}],\"seed\":\"0660cc198330660cc198330660cc1983\",\"fingerprint\":\"7b5d37b8\",\"bip49_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"ypub\":\"upub5DrJcSvsRHYBWUrtoaCjygVQXsBNR4iofB2hUnTMiNBz7axZb2Tfa4j3JV79thdmcm6YzAfwMPH9YK7y2EKyNY4UqgjCxVyfSa9uVUb938D\"}],\"passphrase\":\"whirlpool\",\"accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"xpub\":\"tpubDC9KwqYcT3e9Kp4W72ByimMVpfVGbJB6vDUfhBDtjQvSJGVjnY5HE1yxE8cNPBJrCG72m6jRgCnvWeswZAcMtV3efHbWGBodmiaBmWSQLwY\"}],\"testnet\":true},\"meta\":{\"whirlpool\":{}}}";
        BackupPayload backupPayload = payloadUtil.computeBackupPayload(walletSupplier, null, null);
        String jsonPayload = backupPayload.toJson().toString();
        Assertions.assertEquals(new JSONObject(EXPECTED).toString(), jsonPayload);
    }

    @Test
    public void getPayload_dojo_scode() throws Exception {
        PairingDojo pairingDojo = new PairingDojo("https://dojo.test", "testApiKey");
        String EXPECTED = "{\"wallet\":{\"swaps_accounts\":[{\"changeIdx\":0,\"id\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\"}],\"whirlpool_account\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TW21vo2zdDK9PZgKqnonnomB2b18dadRTgtnB5F8SZg1reqvMHEDKq1k3oHz1AXbsD6MCfNcw77BqfZxWmZm4nn16XNC84mL\",\"id\":2147483645},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TawqjQNFt5o4sBM1RP1B1mtVZr8ysEA9hFLsZZ4RB8oxE4Sfkumc47jnVPUgRL9hJf3sWpTYBKtdkP3UK6J8p1n2ykmjHnrW\",\"id\":2147483646},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TUJkJddzPVbcMBwTwwvqWNTWNxnHQotZzQocFiXvnVVuiYVb9ZYR58PMnSCUxvHTzpVSCm3ttSLXfVviBJspozHYtu6oNtNY\",\"id\":2147483644}],\"bip84_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\",\"id\":0}],\"seed\":\"0660cc198330660cc198330660cc1983\",\"fingerprint\":\"7b5d37b8\",\"bip49_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"ypub\":\"upub5DrJcSvsRHYBWUrtoaCjygVQXsBNR4iofB2hUnTMiNBz7axZb2Tfa4j3JV79thdmcm6YzAfwMPH9YK7y2EKyNY4UqgjCxVyfSa9uVUb938D\"}],\"passphrase\":\"whirlpool\",\"accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"xpub\":\"tpubDC9KwqYcT3e9Kp4W72ByimMVpfVGbJB6vDUfhBDtjQvSJGVjnY5HE1yxE8cNPBJrCG72m6jRgCnvWeswZAcMtV3efHbWGBodmiaBmWSQLwY\"}],\"testnet\":true},\"meta\":{\"whirlpool\":{\"scode\":\"MIXDONTPEEL\"},\"dojo\":{\"pairing\":{\"apikey\":\"testApiKey\",\"url\":\"https://dojo.test\"}}}}";
        BackupPayload backupPayload = payloadUtil.computeBackupPayload(walletSupplier, "MIXDONTPEEL", pairingDojo);
        String jsonPayload = backupPayload.toJson().toString();
        Assertions.assertEquals(new JSONObject(EXPECTED).toString(), jsonPayload);
    }

    @Test
    public void readBackup_1() throws Exception {
        String PAYLOAD = "{\"wallet\":{\"whirlpool_account\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"zpub6rKtc12xtiYXcPMowvBhoNV5XqXDdLAbBPWbTbPGTzzS1ehz94P2KFCKoyeHyUTMFhD5Bj4XevZwrRvBK39hG67SH4x3i5eauzZeQV1EwBw\",\"id\":2147483645},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"zpub6rKtc12xtiYXei7YcAfs88sEB5A4adcAR4gVNfqHMiWdd2hXJSpnVmy65rPjZJRn5bxAkmpSfRzw8Kp4buKygSQAkhmH2uRGrvDsuFLAyiM\",\"id\":2147483646},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"zpub6rKtc12xtiYXa9zjfimmeXHGeXektVaQDttRk5R3gzZwfeNaKTj3rCmnsMrJYsakr9rJ8fF2p6jbU7V3zxApyP6gc72Dh6ZLK9DjYfR3wsy\",\"id\":2147483644}],\"bip84_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"zpub6rKtc12pZ41ZY66Bajg7dPE8G6Gov5qSADMZc5uznJjLwQBX3zpLXPvqMjoTSnh3U4217VnxG7X2jNYJCS4T5QDsYWrLN9yA1eNw1ofrTsz\",\"id\":0}],\"seed\":\"e598320ab2d5c42f94b108ec0dece582\",\"fingerprint\":\"77275290\",\"payment_code_feature\":\"PM8TJbvQrAdpXquDjkh7MQ1ZbtTTXsMVri9ydDbHPWNwNFvuLJanbsqugjLU2CGG78ceHJgui3C94TH2xVBcm9itNvoFSFHV5jkF9z61UfsC5nDFt8o4\",\"bip49_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"ypub\":\"ypub6WvxpidnzPZMy1S6udXxo6WT8dcd7MrQokJKeqE2HLQrbmVGfPzNoyyvtyJJFvxjxLtbFPQfVk8r5m872evxReLMJckqEg8SZum96pzzq7U\"}],\"passphrase\":\"test\",\"accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"xpub\":\"xpub6C2STbGiq9qvjhgfTyXhvHK2HQg4HFgqWcPBVJM82stnyfcLfLTvRKc5M5GCn7t1a5LgsCvvB9bUhQPoLZYFQjN4Wu8yV6y3ZbHtF3KyRXe\"}],\"testnet\":false,\"payment_code\":\"PM8TJbvQrAdpXquDjkh7MQ1ZbtTTXsMVri9ydDbHPWNwNFvuLJanbsqugjLU2CGG78ceHJgui3C94TH2xVBcm9itNvoFSFHV5jkF9z61UfsC5n59n2Xj\"},\"meta\":{\"device_product\":\"Jelly2_EEA\",\"rbf_opt_in\":false,\"blocked_utxos\":{\"blocked\":[],\"blockedPostMix\":[],\"notDustedPostMix\":[],\"notDusted\":[],\"blockedBadBank\":[]},\"xpubpostxreg\":false,\"pin2\":\"\",\"haptic_pin\":true,\"remote\":false,\"xpubricochetlock\":false,\"xpubpostlock\":false,\"pin\":\"00000\",\"xpubprereg\":false,\"use_like_typed_change\":true,\"use_trusted\":false,\"xpubreg84\":true,\"xpubreg44\":true,\"xpubpostreg\":false,\"ricochet_staggered_delivery\":false,\"spend_type\":0,\"xpubreg49\":true,\"use_segwit\":true,\"tx0_display\":[],\"prev_balance\":0,\"device_model\":\"Jelly2\",\"xpubricochetreg\":false,\"paynym_featured_v1\":false,\"rbfs\":[],\"scramble_pin\":true,\"utxo_notes\":[],\"xpublock49\":false,\"device_manufacturer\":\"Unihertz\",\"trusted_no\":\"\",\"user_offline\":false,\"xpublock44\":false,\"xpublock84\":false,\"use_ricochet\":false,\"cahoots\":[],\"tor\":{\"active\":false},\"ricochet\":{\"index\":0,\"staggered\":[],\"xpub\":\"zpub6rKtc12xtiYXhEMfFySB7D762WjSyHZSXnXuz1Q6cordkRu5uabzSpuA5EaB2b8Q7UmvgFCMnCFSBDcjoZ6GfZFodmLdM75MK1dbE1LCeem\",\"queue\":[]},\"paynym_claimed\":false,\"bip47\":{\"pcodes\":[],\"incoming_notif_hashes\":[]},\"xpubbadbanklock\":false,\"auto_backup\":true,\"check_sim\":false,\"batch_send\":[],\"strict_outputs\":true,\"whirlpool\":{},\"sent_tos_from_bip47\":[],\"broadcast_tx\":true,\"paynym_refused\":true,\"localIndexes\":{\"local49idx\":0,\"local84idx\":0,\"local44idx\":0},\"sent_tos\":[],\"utxo_scores\":[],\"version_name\":\"0.99.97a\",\"utxo_tags\":[],\"android_release\":\"10\",\"xpubprelock\":false,\"is_sat\":false}}";
        Assertions.assertEquals(PAYLOAD, payloadUtil.readBackup(BACKUP_FILE, "test").toJson().toString());
    }

    @Test
    public void readBackup_2() throws Exception {
        String BACKUP = "{\"version\":1,\"payload\":\"uZzj8knVwCRFDn\\/CCjjNS2x7yCpWayeDS5IBqyoOAu8WoVGFE0iLQGhvb6ec+E\\/+OAAKzZJU8AmgMTmQX2behgB1f9bZuZdx1VCVzatMr15M+d0MeYTGkgQ0+t2+wF7W362y8ODSTg\\/unnlyyMzhiQprsTNZoRToHVhsrfA+cwkwgTR7RpsQhWxpkPbZ9OI9KFBp00pUcb1kdi\\/P\\/ynUlwpdmPehfavrQ6e5E3ERCd43qlxPug8SIskILDeczJNYIFVfqoQxBllYh+6ETGf2jYYjjeBq95e53OeAedtKAhc6Az6mbpC13UsLZ4Sx6uMY7\\/xeO1ZSMfFVlRylU4NYfjVINRV3cTZ\\/ry48vFUMpeBB94q7BSj3xwHVM4Wh9Trg4IACQzfOO7KFjJ4zTHzUSy0Aq49lWRtMWq9t6UXs\\/qakfkD0Bh8M3JbYtR+Rdwth\\/hBI8q0QCkxd9RxunqfSIrrjcpu5pi7IVIRWjjktc7ZiZNm\\/1awsSFapj9EJ3ZW5H0HXuxi\\/dZt+e1BAe8UlGswcXrXoLbB1r10nA4ayjbsaBDW1yEVaU9B+kHW0CTPujGcFtLRpAeSsjFHQwgNvX41h53JuReBfP0gt8Qs869vWV1M92pyVUCWQ2VH1rPpSv97MzT3BKve\\/xj3DoF9GQR39YUvKft\\/XcaZUIEJBASKcKPJkg7gkJk1IWym8w5lNSiXJlqw06+i7hfZtrppIz+YVr+cPkk64Q3fwsGkI9Zoo1tiqce5T43R8ok3NWYTmvRyiwneP2Cd6sIOg5H0bPDyPGEqdKcmUO5TfkauDabdIL6Z8IivQ1\\/Fq0GiTAyhndfCs31GJswNwlhLmdj6nFQZ4OAz4+T7TNgjacSHMLt5oh30\\/lE33v2xwXiVtAoPysvPVQhR2q98rj8m2UN5OyFqnOD44sjP7EGKKClEwKCWqnle2ruGmazW8wpsjxTeDFz7+S16AsJZHh63sFymk8SmeNKQAH4lStBbv3ilO8wWHMkZNIpYmfCZuZMyL\\/RUD4eJwvzBe9SvWyk4LPmr9nwxxpDOPhCIAuiMSWAY6xQoPHyg5yPrRb0xoetnGfImz2pYG4+f29e1\\/ca1qYssgxIULmQcX6pWSKIhxqro3LHJpfGAsVNKFvn4RFwd0UtjmyiuE1Sf9BYpEYY\\/rqgQ02Hrg8xmpTq2CCKKA3KRU737PQ4NF0IvpIdXzv630wvmA8zF7IlI8XiTVBBlVHRgUBDT99LJCnfDVvV8w1AMGbl600d5fRZ1KguBixRVS65DA+ta49ttMBBiFiwKzquipnLvZy\\/QhGkrjD4XQTpGO0cv1MLFqHpNBN9CGwHDqzu8\\/OTo4zckdvC\\/vDed\\/GFr5\\/yb5GZ+y54KqlFehc51AlceTg992H0NVk5y0dwdCFAgSQkSnCfERTuch9fso81\\/InettTJX\\/\\/QbXwFDeFKVot4hVIAEhHBwcFgPFNRTxqbtpieKzGkxteTPNDTgWFEMOZc\\/MGzYBL3txlP7dp18TioqzOzML3XzAHgU97z81Ls+Dnn2OaBQ53P1gK+ZVcRbGmiWEU0B\\/uM4lKESEIS03GhAX9EM2C8jR5SGk+mpaX7O9aQa9D\\/SaIgcrqnGyO2RpL+vhWp3Dtbx9pUuKFa6QfeC62jomUO8g0kissGRCROpD0oASOncoiagE7S1kmW0P6+xZ2tLXsriAQ8cSsJeZM2FbCK\\/4ELCPPRqdmJpcMGWFl64zY+3tRgp8bd4hq+tswFJPe\\/XTmgh5ebxRQuZ2F+f++iZFbaG3CzxQDVx62gVN1K1Y9\\/4EDJc+4LHRo8hk\\/perNYkMfjkHoonBD2\\/02aIIE2tZhTpVdM7kDwJ5U2xN5OedKwJuhvV+mWpCnd7XCRz1Y9zat\\/8QJrU5Rgz1IRH\\/PB8PIpzc\\/ImlIyT6mhOPamA3EkkHlhNhZEGwPXIje925EltpmukTIDw6+5RI66wYx9uQu68rTcPrExr9qoIbQx5yCuxPi6ENnAL\\/YzaM1b8tKagVSsg+nzf8H0oBtN8jXj\\/Pam6DPrZ+1DpyR77eox4YqkG+8LlAZffGrkL6zmEctX4ACRzhINXs\\/dBA39YZqm2\\/9nPPYVSRe2JTxFvoiep\\/HRFj\\/hWUoF8nr\\/6yUI30M+996YxdShw5B6bsfX9AFppWmSzu7PBd\\/IOh6pXygRN7I+CV\\/uQjaa2Epz4OeLIr8k1I9SYkBOlaokMFUQyzFxgsalxRoBmIdZ8NperBHJaT03s7mP1aZS3qh6Svb564UaiVNJ8EnQ4OMm8OLvVW0P87d9p9Uwudoey2\\/wIJ2AWamAKYfs8pUZUzB79KeqwRIjK2y34KfnOTTzt\\/C+0zxoDJI\\/9F6RvRwgyYfhRXz6FHrvqDiiiNWEQ2Uvfk40N7D6KiFoTPnd4nX+pGeaU1UbJoi8gM\\/UQiXIb+44swkfzItx7XSFGWQoro8E5dHT+5qe+M3uHDp35MkTIK+8bdfIDuY15RG9CgJgV3IXqQlKomvdtj63\\/Fh56srKHCPzITG3KTwEqnn94Z5kCPfGEpd2lcUbxAsnZwUg++3aLZn5CLmHFyBvPtjIVFMP\\/Zl4lmljKGzfK7TCFWq0pocykqxrCnLBbyBeh3j5qQ8ygtcZTx2ayN+Qyj7QAMIEKn+EBU6iGQo8FIK1nHb0zI6c1ffFV2OMU7vdW7uT9EiRLwElsgNuukXk\\/rMKJiKDQB4EWmbdFDZVSBN2YHldewUypO\\/Eraui3KWZIzPslCysCxyTV+DegAK53aEV+E+aH+GTjIAdCQW52r3Ypmc+bHDXflCS9HQQwkSPwMFU4hrhgmSwBFR1Yz2MwRjC3lswxtDoP\\/4NdwB1kYFaa+XvyzHSI6OfXsPZYZ6OaVJlfxhi+Vi18OVS0WTfCouGQUNmy0gyC3VnkNDI8C7oNrkQ3\\/Hs3LJgaN0homiShhGiMxIKUOQ2IIT\\/zlXnVyHQms0sW8C23rwbPrzKJXd\\/dzVL44ZKDhS62zCe1yDbSXDlG8Goa\\/pf8UXZddGoKLTsaNCKAOBQDnxtTF1oeEZ+y3Z5nfcjT81gOLCVKZSXEAyTccitG9nPxIPmexfhiPoyI9Q2\\/QJ1S8XGVQenzJpNT3UTISAnsbmp3w2jtK16MS7CqAwxqLuYjvLVuKg5S6gYz57Hn7NDtWSf5d8X\\/uxj63MSgwEFBBWNPK\\/24gabzxBJiOofbj47D6Wpy4DK2OSO2HIW1qgPPIZyFyc1VWIC2R\\/RfOfGqr5qlbdd8UmWPGN5UXlFOWIwILDZup08Sh3a4GufW62YpPEwXuP5f9JCatSVzSTnJeG9\\/tKydD+FP94ENdv3loWhvZZkViRMn\\/51V6iTbo0ur1ws\\/6SXjpCho3Hea+v2vsInflRQK4CnmWceCXF0uGzd9HU\\/uPV8qEnS7KG9uTVh9NjTqUYJjdj6T3lwLHyKDwxBfYIDd+qBtckj5VSRZmxTEZRhUff3+97HBWbiR47TLrDxefc4+JnWdy9Tbs5H8sWUf03d3HpMfVmZ+4waPvEwaQjQEyYac2OWx6daaD0iRYg+UbDfWPgyI\\/\\/XITAPOVh4pK3zkP1KR+c+3eFrKEPTsW7eZL2w+S8vDtmeo3b2P+4TXnILur9W8ik58uj+k=\",\"external\":true}";

        BackupPayload bp = payloadUtil.readBackup(BACKUP, "dojo");
        Assertions.assertTrue(bp.isWalletTestnet());
        Assertions.assertEquals("8e33ef54e2220e8f16cf9d3fa377af36", bp.getWalletSeed());
        Assertions.assertEquals("dojo", bp.getWalletPassphrase());
        Assertions.assertEquals("{\"whirlpool_account\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YuvSYMQKpjBH3RMRcJMcim1GmFw2R7q7TqrndzktQYDGxENLrveBtp5Re3uqFKeX6pQyFj8AwBHhVp5SMZMM5vkf7Dh6Mp9Eu4KLChmnpi\",\"id\":2147483645},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YuvSYMQKpjBK74mno2H8gK9H7r6phtcwAWteDsTX9vCXRTFJaasykwxEKfgEUxUoGAmMpn61F7vo5ghg9Ewu7FtBFQ8jgzdBjEEFqgb1wu\",\"id\":2147483646}],\"bip84_accounts\":[{\"changeIdx\":0,\"receiveIdx\":1,\"zpub\":\"vpub5YuvSYMFzACDDtL1AmKaziGa5KpbtmJgVHtXRC7iaMZuryymPRp2gaj8niJx3zvrsjyK2GchrtNKMXnVmGRRSPYuMFh6Doe8a3auymYuY5N\",\"id\":0}],\"seed\":\"8e33ef54e2220e8f16cf9d3fa377af36\",\"payment_code_feature\":\"PM8TJY93PDBRzWyTq395t5SbK9D1KoXuCdos5t86MD81dJiXTN5dpKaFC21Gmx7p1yBnzeNHMxzrzkh5a5SVLGfceAQRQzrmn51KJvFpkm4pRYfr3JdH\",\"bip49_accounts\":[{\"changeIdx\":0,\"receiveIdx\":1,\"id\":0,\"ypub\":\"upub5EuEwdf7cCPEfd9PcQoRsVXrPXYp5bo3bsoVrBqhrnWg5no47jo3ZcoeZjPhvv55m7RbMemGeACg6jhKvvmduo1C6hoqiA8gkYScua86e8s\"}],\"passphrase\":\"dojo\",\"accounts\":[{\"changeIdx\":0,\"receiveIdx\":1,\"id\":0,\"xpub\":\"tpubDC5DPqbtbZhMUaxzi9kWHowygS6aNMU6gEFzfNW3rTpRoVqz2yZKFhrAR99znxTpBrEXmem4UTwXJhF3HbosHLzYC32heFVdVrwQoX3oNke\"},{\"changeIdx\":0,\"receiveIdx\":0,\"id\":1,\"xpub\":\"tpubDC5DPqbtbZhMWaJRKqKxtzFqyYareWUYDUkj36ceTvU4mr7jX87xxBdj5J7Jy6QeQmnxrYpbx3FYCk8Juq4CAyzeGui2aPDHcbNr7tEbUwp\"}],\"testnet\":true,\"payment_code\":\"PM8TJY93PDBRzWyTq395t5SbK9D1KoXuCdos5t86MD81dJiXTN5dpKaFC21Gmx7p1yBnzeNHMxzrzkh5a5SVLGfceAQRQzrmn51KJvFpkm4pRYbF3zEf\"}", bp.getWallet().toString());
        Assertions.assertEquals("{\"device_product\":\"dreamltexx\",\"rbf_opt_in\":false,\"blocked_utxos\":{\"blocked\":[],\"blockedPostMix\":[],\"notDusted\":[]},\"pin2\":\"\",\"haptic_pin\":true,\"remote\":false,\"xpubpostlock\":false,\"pin\":\"12345\",\"use_like_typed_change\":true,\"use_trusted\":false,\"xpubreg84\":true,\"xpubreg44\":true,\"ricochet_staggered_delivery\":false,\"spend_type\":0,\"xpubreg49\":true,\"use_segwit\":true,\"prev_balance\":0,\"dojo\":{\"pairing\":{\"apikey\":\"myAdminKey\",\"type\":\"dojo.api\",\"version\":\"1.0.0\",\"url\":\"http://6wxsigov46pdswkcycxrr4s5j4mrvldhve3kvwxaipdbkmrgzq3gjiqd.onion/test/v2/\"}},\"device_model\":\"SM-G950F\",\"paynym_featured_v1\":false,\"rbfs\":[],\"scramble_pin\":true,\"xpublock49\":true,\"device_manufacturer\":\"samsung\",\"trusted_no\":\"\",\"user_offline\":false,\"xpublock44\":true,\"xpublock84\":true,\"use_ricochet\":false,\"cahoots\":[],\"tor\":{\"active\":true},\"ricochet\":{\"index\":0,\"staggered\":[],\"queue\":[]},\"paynym_claimed\":true,\"bip47\":{\"pcodes\":[],\"incoming_notif_hashes\":[]},\"trusted_node\":{\"validated\":false,\"port\":8332},\"auto_backup\":true,\"check_sim\":false,\"batch_send\":[],\"whirlpool\":{\"pre_index\":0,\"post_index\":0},\"sent_tos_from_bip47\":[],\"broadcast_tx\":true,\"paynym_refused\":false,\"sent_tos\":[],\"use_trusted_node\":false,\"version_name\":\"0.99.83\",\"utxo_tags\":[],\"android_release\":\"9\",\"xpubprelock\":true,\"fee_provider_sel\":0}", bp.getMeta().toString());
    }

    @Test
    public void writeBackup() throws Exception {
        PairingDojo pairingDojo = new PairingDojo("https://dojo.test", "testApiKey");
        String password = "test";

        String EXPECTED = "{\"wallet\":{\"swaps_accounts\":[{\"changeIdx\":0,\"id\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\"}],\"whirlpool_account\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TW21vo2zdDK9PZgKqnonnomB2b18dadRTgtnB5F8SZg1reqvMHEDKq1k3oHz1AXbsD6MCfNcw77BqfZxWmZm4nn16XNC84mL\",\"id\":2147483645},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TawqjQNFt5o4sBM1RP1B1mtVZr8ysEA9hFLsZZ4RB8oxE4Sfkumc47jnVPUgRL9hJf3sWpTYBKtdkP3UK6J8p1n2ykmjHnrW\",\"id\":2147483646},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TUJkJddzPVbcMBwTwwvqWNTWNxnHQotZzQocFiXvnVVuiYVb9ZYR58PMnSCUxvHTzpVSCm3ttSLXfVviBJspozHYtu6oNtNY\",\"id\":2147483644}],\"bip84_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\",\"id\":0}],\"seed\":\"0660cc198330660cc198330660cc1983\",\"fingerprint\":\"7b5d37b8\",\"bip49_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"ypub\":\"upub5DrJcSvsRHYBWUrtoaCjygVQXsBNR4iofB2hUnTMiNBz7axZb2Tfa4j3JV79thdmcm6YzAfwMPH9YK7y2EKyNY4UqgjCxVyfSa9uVUb938D\"}],\"passphrase\":\"whirlpool\",\"accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"xpub\":\"tpubDC9KwqYcT3e9Kp4W72ByimMVpfVGbJB6vDUfhBDtjQvSJGVjnY5HE1yxE8cNPBJrCG72m6jRgCnvWeswZAcMtV3efHbWGBodmiaBmWSQLwY\"}],\"testnet\":true},\"meta\":{\"whirlpool\":{\"scode\":\"MIXDONTPEEL\"},\"dojo\":{\"pairing\":{\"apikey\":\"testApiKey\",\"url\":\"https://dojo.test\"}}}}";

        // create backup file
        File file = new File("/tmp/testBackup");
        payloadUtil.writeBackup(walletSupplier, "MIXDONTPEEL", pairingDojo, password, file);

        // verify
        BackupPayload bp = payloadUtil.readBackup(file, password);
        Assertions.assertEquals("0660cc198330660cc198330660cc1983", bp.getWalletSeed());
        Assertions.assertEquals("whirlpool", bp.getWalletPassphrase());
        Assertions.assertEquals("{\"whirlpool_account\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TW21vo2zdDK9PZgKqnonnomB2b18dadRTgtnB5F8SZg1reqvMHEDKq1k3oHz1AXbsD6MCfNcw77BqfZxWmZm4nn16XNC84mL\",\"id\":2147483645},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TawqjQNFt5o4sBM1RP1B1mtVZr8ysEA9hFLsZZ4RB8oxE4Sfkumc47jnVPUgRL9hJf3sWpTYBKtdkP3UK6J8p1n2ykmjHnrW\",\"id\":2147483646},{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDXWE3TUJkJddzPVbcMBwTwwvqWNTWNxnHQotZzQocFiXvnVVuiYVb9ZYR58PMnSCUxvHTzpVSCm3ttSLXfVviBJspozHYtu6oNtNY\",\"id\":2147483644}],\"bip84_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\",\"id\":0}],\"seed\":\"0660cc198330660cc198330660cc1983\",\"fingerprint\":\"7b5d37b8\",\"bip49_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"ypub\":\"upub5DrJcSvsRHYBWUrtoaCjygVQXsBNR4iofB2hUnTMiNBz7axZb2Tfa4j3JV79thdmcm6YzAfwMPH9YK7y2EKyNY4UqgjCxVyfSa9uVUb938D\"}],\"passphrase\":\"whirlpool\",\"accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"id\":0,\"xpub\":\"tpubDC9KwqYcT3e9Kp4W72ByimMVpfVGbJB6vDUfhBDtjQvSJGVjnY5HE1yxE8cNPBJrCG72m6jRgCnvWeswZAcMtV3efHbWGBodmiaBmWSQLwY\"}],\"testnet\":true,\"swaps_accounts\":[{\"changeIdx\":0,\"receiveIdx\":0,\"zpub\":\"vpub5YEQpEDPAZWVTkmWASSHyaUMsae7uV9FnRrhZ3cqV6RFbBQx7wjVsUfLqSE3hgNY8WQixurkbWNkfV2sRE7LPfNKQh2t3s5une4QZthwdCu\",\"id\":0}]}", bp.getWallet().toString());
        Assertions.assertEquals("{\"whirlpool\":{\"scode\":\"MIXDONTPEEL\"},\"dojo\":{\"pairing\":{\"apikey\":\"testApiKey\",\"url\":\"https://dojo.test\"}}}", bp.getMeta().toString());

        String jsonPayload = bp.toJson().toString();
        Assertions.assertEquals(new JSONObject(EXPECTED).toString(), jsonPayload);
    }
}
